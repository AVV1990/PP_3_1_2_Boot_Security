<!DOCTYPE html>

<html lang="en" >

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.min.js" integrity="sha384-cVKIPhGWiC2Al4u+LWgxfKTRIcfu0JTxR+EQDz/bgldoEyl4H0zUF0QKbrJ0EcQF" crossorigin="anonymous"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    a {
      text-decoration: none; /* Убираем подчёркивание */
    }
  </style>


</head>

<body>

<div  class="container-fluid" >

  <div class="row">
    <div class="p-3 mb-2 bg-dark text-white">
      <div class="d-grid gap-2 d-md-flex justify-content-md-end"><span><a class="text-white"  href="/logout">logout</a></span></div>
      <span id= "adminPage"  class="fw-bold"></span>
    </div>
  </div>

  <div  class="d-flex align-items-start" >
    <div class="col-2">
      <div class="nav flex-column nav-pills me-3" id="v-pills-tab" role="tablist" aria-orientation="vertical">
        <a class="nav-link active" id="v-pills-home-tab" data-bs-toggle="pill" href="#admin" role="tab" aria-controls="v-pills-home" aria-selected="true">Admin</a>
        <a class="nav-link" id="v-pills-profile-tab" data-bs-toggle="pill" href="#user"  role="tab" aria-controls="v-pills-profile" aria-selected="false">User</a>
      </div>
    </div>


    <div class="w-100 p-3" style="background-color: #eee;" >
      <div class="tab-content" id="v-pills-tabContent">
        <div  class="tab-pane fade show active" id="admin" role="tabpanel" aria-labelledby="v-pills-home-tab">
          <h1> Admin panel </h1>
          <ul class="nav nav-tabs">
            <li class="nav-item" >
              <a class="nav-link active" data-bs-toggle="pill" href="#users" role="tab" >Users table</a>
            </li>

            <li class="nav-item">
              <a class="nav-link"  data-bs-toggle="pill" href="#new" role="tab">New User</a>
            </li>
          </ul>


          <div class="border">
            <div class="tab-content">
              <div id="users" class="tab-pane fade" >
                <div class="row-fluid px-3 py-2 border-bottom">
                  <h5>All users</h5>
                  <div class="row-fluid bg-white">
                    <div class="col p-4">
                      <table   class="table table-striped" >
                        <thead>
                        <tr>
                          <th scope="col">ID</th>
                          <th scope="col">First name</th>
                          <th scope="col">Last name</th>
                          <th scope="col">Age</th>
                          <th scope="col">Email</th>
                          <th scope="col">Role</th>
                          <th scope="col">Edite</th>
                          <th scope="col">Delete</th>
                        </tr>
                        </thead>
                        <tbody id="tbData">
                        </tbody>
                      </table>

                      <!-- Modal -->
                      <div class="modal fade" id="edit" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <h5 class="modal-title">Edit user</h5>
                              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                            </div>
                            <div class="modal-body">
                              <div class="form-group">
                                <label for="id" class="control-label"><b>ID</b></label>
                                <input type="number" class="form-control" disabled="true"  id="id"/>
                              </div>

                              <div class="form-group">
                                <label for="firstName" class="control-label"><b>First name</b></label>
                                <input type="text" class="form-control"  id="firstName"/>
                              </div>

                              <div class="form-group">
                                <label for="lastName" class="control-label"><b>Last name</b></label>
                                <input type="text" class="form-control"  id="lastName"/>
                              </div>

                              <div class="form-group">
                                <label for="age" class="control-label"><b>Age</b></label>
                                <input type="number" class="form-control"  id="age"/>
                              </div>

                              <div class="form-group">
                                <label for="mail" class="control-label"><b>Email</b></label>
                                <input type="text" class="form-control" id="mail"/>
                              </div>

                              <div class="form-group">
                                <label for="password" class="control-label"><b>Password</b></label>
                                <input type="password" class="form-control"  id="password">
                              </div>

                              <div class="form-group">
                                <label for="roles" ><b>Role</b></label>
                                <select  multiple="multiple" size="2"  id="roles" name="roles" class="form-control">
                                  <!--                                <option value=""></option>-->
                                </select>
                              </div>
                            </div>

                            <div class="modal-footer">
                              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                              <button type="submit" class="btn btn-primary" onclick="submitForm()" data-bs-dismiss="modal" >Edit</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>


              <div id="new" class="tab-pane fade">
                <div class="row-fluid px-3 py-2 border-bottom">
                  <h5>Add new user</h5>
                  <div class="row-fluid bg-white">
                    <div class="d-flex justify-content-center p-4">

                      <div  class="w-25 font-weight-bold text-center">
                        <div class="form-group">
                          <label ><b>First name</b></label>
                          <input type="text" class="form-control"  id="firstName1" placeholder="First name" >
                        </div>

                        <div class="form-group">
                          <label ><b>Last name</b></label>
                          <input type="text" class="form-control"  id="lastName1" placeholder="Last name">
                        </div>

                        <div class="form-group">
                          <label ><b>Age</b></label>
                          <input type="number" class="form-control"   id="age1" placeholder="Age">
                        </div>

                        <div class="form-group">
                          <label ><b>Email</b></label>
                          <input type="text" class="form-control"  id="mail1" placeholder="Email">
                        </div>

                        <div class="form-group">
                          <label ><b>Password</b></label>
                          <input type="password" class="form-control"  id="password1"  placeholder="Password">
                        </div>

                        <div class="form-group">
                          <label><b>Role</b></label>
                          <select  multiple="multiple" size="2" id="roles1" class="form-control">
                            <!--                          <option value=""></option>-->
                          </select>
                        </div>

                        <h1></h1>
                        <button type="submit" class="btn btn-success" onclick="addForm()">Add new user</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="user" role="tabpanel" aria-labelledby="v-pills-profile-tab">
          <h1> User information-page </h1>
          <div class="row-fluid px-3 py-2 border-bottom">
            <h5>About user</h5>
          </div>

          <div class="row-fluid bg-white">
            <div class="col p-4">
              <table class="table table-striped" >
                <thead>
                <tr>
                  <th scope="col">ID</th>
                  <th scope="col">First name</th>
                  <th scope="col">Last name</th>
                  <th scope="col">Age</th>
                  <th scope="col">Email</th>
                  <th scope="col">Role</th>
                </tr>
                </thead>
                <tbody id="tbDataUser">
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<script>


  getPage();
  getData();
  setFormRole();
  setFormRole1();
  getUserData()

  function setFormData(id,firstName,lastName,age,mail,password) {
    document.getElementById("id").value = id;
    document.getElementById("firstName").value = firstName;
    document.getElementById("lastName").value = lastName;
    document.getElementById("age").value = age;
    document.getElementById("mail").value = mail;
    document.getElementById("password").value = password;
  }

  function setFormRole() {
    fetch("http://localhost:8080/admin/getRoles").then(
            (res) => res.json()
    ).then((response) => {

      let fragment = document.createDocumentFragment();

      response.forEach((role) => {
        let optionElem = new Option(role.name, role.name);
        fragment.appendChild(optionElem);
      })
      document.getElementById("roles").appendChild(fragment);
    })
  }

  function setFormRole1() {
    fetch("http://localhost:8080/admin/getRoles").then(
            (res) => res.json()
    ).then((response) => {

      let fragment = document.createDocumentFragment();

      response.forEach((role) => {
        let optionElem = new Option(role.name, role.name);

        fragment.appendChild(optionElem);
      })
      document.getElementById("roles1").appendChild(fragment);
    })
  }

  function clearFormData() {
    document.getElementById("firstName1").value = "";
    document.getElementById("lastName1").value = "";
    document.getElementById("age1").value = "";
    document.getElementById("mail1").value = "";
    document.getElementById("password1").value = "";
  }


  function editDataCall(id) {
    // call get user details by id API
    fetch("http://localhost:8080/admin/getUser/"+id,{
      method:"GET"
    }).then((res)=>res.json()).then((response)=>{
      setFormData(response.id,response.firstName,response.lastName,response.age, response.mail, response.password);
    })
  }

  // add data - called this function when user click on button Add new user
  function addForm() {

    fetch("http://localhost:8080/admin/getRoles"
    ).then(
            (res) => res.json()
    ).then((response) => {
      console.log(response)

      let select = document.getElementById("roles1");
      let selected = [...select.options]
              .filter(option => option.selected)
              .map(option => option.value);



      let filteredRoles = [];

      if (selected.length == 1 && selected.includes(response[0].name)) {
        filteredRoles.push(response[0])
      }

      if (selected.length == 1 && selected.includes(response[1].name)) {
        filteredRoles.push(response[1])
      }

      if (selected.length == 2 && selected.includes(response[0].name) && selected.includes(response[1].name)) {
        filteredRoles.push(response[0])
        filteredRoles.push(response[1])
      }

      let user = {

        firstName: document.getElementById("firstName1").value,
        lastName: document.getElementById("lastName1").value,
        age: document.getElementById("age1").value,
        mail: document.getElementById("mail1").value,
        password: document.getElementById("password1").value,
        roles: filteredRoles
      }
      console.log(JSON.stringify(user))

      fetch("http://localhost:8080/admin/addUser", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(user)
      })
              .then((response) => {
                clearFormData(); // clear the form field
                getData(); // reload the table
                location.href = "pageAdmin.html"
              })
    })
  }


  // edit data - called this function when user click on button Edit
  function submitForm() {
    fetch("http://localhost:8080/admin/getRoles"
    ).then(
            (res) => res.json()
    ).then((response) => {

      let select = document.getElementById('roles');
      let selected = [...select.options]
              .filter(option => option.selected)
              .map(option => option.value);

      let filteredRoles = [];

      if (selected.length == 1 && selected.includes(response[0].name)) {
        filteredRoles.push(response[0])
      }

      if (selected.length == 1 && selected.includes(response[1].name)) {
        filteredRoles.push(response[1])
      }

      if (selected.length == 2 && selected.includes(response[0].name) && selected.includes(response[1].name)) {
        filteredRoles.push(response[0])
        filteredRoles.push(response[1])
      }


      let user = {
        id: document.getElementById("id").value,
        firstName: document.getElementById("firstName").value,
        lastName: document.getElementById("lastName").value,
        age: document.getElementById("age").value,
        mail: document.getElementById("mail").value,
        password: document.getElementById("password").value,
        roles: filteredRoles
      }

      fetch("http://localhost:8080/admin/updateUser/" + document.getElementById("id").value, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(user)
      })
              .then((response) => {
                getData(); // reload the table
                getPage(); // reload the panel
                getUserData() // reload the table of user
              })
    })
  }



  // delete data
  function deleteData(id) {
    fetch("http://localhost:8080/admin/deleteUser/"+id,{
      method: "DELETE"
    })
            .then(
                    ()=>{
                      getData();
                    }
            )
  }

  function getData() {
    fetch("http://localhost:8080/admin/getUsers").then(
            (res)=>res.json()
    ).then((response)=>{
      let tmpData  = '';

      response.forEach((user) => {


        var uniqueNames = [];
        user.roles.forEach((role) => {
          uniqueNames.push(role.name)
        });

        tmpData+="<tr>"
        tmpData+="<td>"+user.id+"</td>";
        tmpData+="<td>"+user.firstName+"</td>";
        tmpData+="<td>"+user.lastName+"</td>";
        tmpData+="<td>"+user.age+"</td>";
        tmpData+="<td>"+user.mail+"</td>";
        tmpData+="<td>"+uniqueNames+"</td>";
        tmpData+="<td><button class='btn btn-primary'  data-bs-toggle='modal' data-bs-target='#edit' onclick='editDataCall("+user.id+")'>Edit</button></td>";
        tmpData+="<td><button class='btn btn-danger'  onclick='deleteData("+user.id+")'>Delete</button></td>";

        tmpData+="</tr>";

      })
      document.getElementById("tbData").innerHTML = tmpData;

    })
  }
  function getUserData() {
    fetch("http://localhost:8080/user").then(
            (res)=>res.json()
    ).then((response)=>{
      let tmpData  = '';

      var uniqueNames = [];
      response.roles.forEach((role) => {
        uniqueNames.push(role.name)
      });

      tmpData+="<tr>"
      tmpData+="<td>"+response.id+"</td>";
      tmpData+="<td>"+response.firstName+"</td>";
      tmpData+="<td>"+response.lastName+"</td>";
      tmpData+="<td>"+response.age+"</td>";
      tmpData+="<td>"+response.mail+"</td>";
      tmpData+="<td>"+uniqueNames+"</td>";

      tmpData+="</tr>";


      document.getElementById("tbDataUser").innerHTML = tmpData;

    })
  }

  function getPage() {
    fetch("http://localhost:8080/user").then(
            (res)=>res.json()
    ).then((response)=>{
      let tmpData  = '';

      var uniqueNames = [];
      response.roles.forEach((role) => {
        uniqueNames.push(role.name)
      });

      tmpData+="<tr>"
      tmpData+="<td>"+response.mail+"</td>";
      tmpData+="<td> </td>";
      tmpData+="<td>with roles</td>";
      tmpData+="<td> </td>";
      tmpData+="<td>"+uniqueNames+"</td>";

      tmpData+="</tr>";


      document.getElementById("adminPage").innerHTML= tmpData;
    })
  }

  // getPage();
  // getData();
  // setFormRole();
  // setFormRole1();
  // getUserData()



</script>


<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>
</html>